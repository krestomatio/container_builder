#!/bin/bash -e
# description: source code for app using git and rsync

usage() {
    cat 1>&2 <<"EOF"
Script to pull and/or sync app code.

ENVIRONMENT VARS:
GIT_branch              branch to pull from
GIT_commit              commit to verify
GIT_dest                git destination
APP_dest                sync destination

USAGE:
    app-git [OPTIONS]

OPTIONS (app git):
  -a                     use rsync archive mode
  -p                     pull from "${GIT_branch}" before syncing
  -v                     veriy git commit matches "${GIT_commit}"
  -s                     sync code from "${GIT_dest}" to "${APP_dest}"
  -d                     delete files in "${APP_dest}" not present in "${GIT_dest}"
  -e                     exclude criteria. Ex -e '.git*'

EXAMPLES:
    app-git -s
    app-git -s -e '.git*'
    app-git -s -d -e 'config.php' -e '.git*'
    app-git -p -v -s -a
EOF
}

pull=false
sync=false
verify=false
rsync_options="-icrlD"

while getopts ":apvsde:" opt; do
  case ${opt} in
    a )
        rsync_options="-ia"
        ;;
    p )
        pull=true
        ;;
    v )
        verify=true
        ;;
    s )
        sync=true
        ;;
    d )
        delete=true
        ;;
    e )
        exclude_php+=(--exclude="${OPTARG}")
        ;;
    \? )
        usage
        exit
        ;;
  esac
done
shift $((OPTIND -1))

if (( $OPTIND == 1 )); then
    echo -e "No option\n"
    usage
    exit 1
fi

echo "git dir:"
pushd ${GIT_dest}

# Pull
if  [ "$pull" != "false" ]; then
    echo -e "\npulling from branch ${GIT_branch} to '${GIT_dest}'..."
    git pull origin "${GIT_branch}"
fi

# Verify commit
if  [ "$verify" != "false" ]; then
    echo -e "\nverifying ${GIT_commit}..."
    git rev-parse --verify HEAD | grep -q "${GIT_commit}"
fi

# add exclude to rsync_options
if ! [ -z $exclude_php ]; then
    echo -e "\nadding: '${exclude_php[@]}'..."
    rsync_options+=" ${exclude_php[@]}"
fi

# add delete option
if ! [ -z $delete ]; then
    echo -e "\nadding delete option..."
    rsync_options+=" --delete"
fi

# create clean copy, excluding .git* and files in .gitignore
if  [ "$sync" != "false" ]; then
    echo -e "\nsyncing to '${APP_dest}'..."
    rsync ${rsync_options} \
        --filter='dir-merge,- .gitignore' "${GIT_dest}/" "${APP_dest}"
fi

echo -e "\nreturning to:"
popd

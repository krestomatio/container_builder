#!/bin/bash

set -e

# Disabled subscription-manager
sed -i "s@^enabled.*@enabled=0@" /etc/yum/pluginconf.d/subscription-manager.conf

# default USER in root group
usermod -a -G ${CGROUP} ${CUSER}

# In order to drop the root user, we have to make some directories world
# writeable as OpenShift default security model is to run the container under
# random UID.

mkdir -p ${PHP_RUN}
chmod -R a+rwx ${PHP_RUN}
chmod -R a+rwx ${HTTPD_MAIN_CONF_PATH}
chmod -R a+rwx ${HTTPD_MAIN_CONF_D_PATH}
chmod -R a+rwx ${HTTPD_VAR_RUN}
chmod -R a+rwx ${HTTPD_LOG_PATH}
mkdir -p /tmp/sessions
chmod -R a+rwx /tmp/sessions
chown -R ${CUSER_ID}:${CGROUP_ID} /tmp/sessions
chown -R ${CUSER_ID}:${CGROUP_ID} ${HTTPD_PUBLIC_PATH}
chmod -R a+rwx ${PHP_SYSCONF_PATH}

# httpd default config
sed -i \
    -e "s@^Listen 80.*@Listen 8080@" \
    -e "s@^User.*@User ${CUSER}@" \
    -e "s@^Group.*@Group ${CGROUP}@" \
    -e "s@^DocumentRoot.*@DocumentRoot \"${HTTPD_PUBLIC_PATH}\"@" \
    -e "s@^<Directory \"/var/www/html\"@<Directory \"${HTTPD_PUBLIC_PATH}\"@" \
    -e "s@^ErrorLog \"logs/error_log\"@ErrorLog \"|/usr/bin/cat\"@" \
    -e "s@CustomLog \"logs/access_log\"@CustomLog \"|/usr/bin/cat\"@" \
    ${HTTPD_MAIN_CONF_PATH}/httpd.conf

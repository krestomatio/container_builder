#!/bin/bash -e
# description: base config for httpd

# In order to drop the root user, we have to make some directories world
# writeable as OpenShift default security model is to run the container under
# random UID.

chmod -R a+rwx ${HTTPD_MAIN_CONF_PATH}
chmod -R a+rwx ${HTTPD_MAIN_CONF_D_PATH}
chmod -R a+rwx ${HTTPD_VAR_RUN}
chmod -R a+rwx ${HTTPD_LOG_PATH}
chown -R ${CUSER_ID}:${CGROUP_ID} ${HTTPD_PUBLIC_PATH}

# httpd default config
sed -i \
    -e "s@^Listen 80.*@Listen 8080@" \
    -e "s@^User.*@User ${CUSER}@" \
    -e "s@^Group.*@Group ${CGROUP}@" \
    -e "s@^DocumentRoot.*@DocumentRoot \"${HTTPD_PUBLIC_PATH}\"@" \
    -e "s@^<Directory \"/var/www/html\"@<Directory \"${HTTPD_PUBLIC_PATH}\"@" \
    -re 's@^(\s*CustomLog)\s+\S+@\1 /proc/self/fd/1@g' \
    -re 's@^(\s*ErrorLog)\s+\S+@\1 /proc/self/fd/2@g' \
    -re 's@^(\s*TransferLog)\s+\S+@\1 /proc/self/fd/1@g' \
    ${HTTPD_MAIN_CONF_PATH}/httpd.conf

- name: release
  hosts: "{{ play_containers | default('all') }}"
  connection: local
  diff: "{{ play_diff | default(omit) }}"
  vars_files: "vars/ci.yml"
  vars:
    version_include_major_minor_tags: true
    skopeo_src_image_tag: "{{ lookup('file', '/tmp/PROMOTE_TAG') | default(false,true) }}"
    build_image_name: "{{ build_registry_path }}/{{ ansible_host }}"
    git_add_path: vars/state generated_contexts/
    git_commit_msgs:
      - "chore(ci): save state of images"
      - "[skip.ci]"
  environment:
    DOCKER_BUILDKIT: 1
  tasks:
    - name: include skip-ci
      include_tasks: tasks/pipeline/skip-ci.yml
      run_once: true

    - name: include provider variables
      include_tasks: tasks/pipeline/provider-vars.yml

    - name: check valid builder
      tags: always
      run_once: true
      assert:
        that: dockerfile_builder in ['docker','podman']

    - name: git related config
      include_tasks: "tasks/git/config.yml"
      run_once: true

    - name: builder related config
      include_tasks: "tasks/config/{{ dockerfile_builder }}.yml"
      when: builder_config | default(false) | bool
      run_once: true

    - name: set version related facts
      include_tasks: tasks/builder/version.yml

    - name: promote image
      include_tasks: tasks/promote/copy.yml

    - name: save image state
      include_tasks: tasks/state/save.yml

    - name: push image state changes
      run_once: true
      block:
      - name: add changes
        include_tasks: tasks/git/add.yml

      - name: commit changes
        include_tasks: tasks/git/commit.yml

      - name: push changes
        include_tasks: tasks/git/push.yml

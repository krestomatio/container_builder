#!/bin/bash -e
# description: base config for nfs-ganesha

# persistent user id
sed "/^${CTR_USER}/d" /etc/passwd | grep -q -w ${CTR_USER_ID} && exit 1 || echo "Setting userid to ${CTR_USER_ID}..."
sed -i "s@^ganesha:.*@ganesha:x:${CTR_USER_ID}:${CTR_USER_ID}:NFS-Ganesha Daemon:/run/ganesha:/sbin/nologin@" /etc/passwd

sed "/^${CTR_USER}/d" /etc/passwd | grep -q -w ${CTR_USER_ID} && exit 1 || echo "setting
groupid to ${CTR_USER_ID}..."
sed -i "s@^ganesha:.*@ganesha:x:${CTR_USER_ID}:@" /etc/group

# do not ask systemd for user IDs or groups (slows down dbus-daemon start)
sed -i s/systemd// /etc/nsswitch.conf

# create default conf
mkdir -p ${NFS_GANESHA_CONF_DIR} ${NFS_GANESHA_CONF_EXPORTS_DIR} ${NFS_GANESHA_EXPORTS_DIR} ${NFS_GANESHA_EXPORT_DIR} ${NFS_GANESHA_DBUS_RUN_DIR}

cat << _EOF > ${NFS_GANESHA_CONF_FILE}
NFS_CORE_PARAM {
    Protocols = 4;
    NFS_Protocols = 4;
    Enable_RQUOTA = false;
    Enable_UDP = false;
}
EXPORT_DEFAULTS{
    Transports = TCP;
    SecType = sys;
}
%include ${NFS_GANESHA_CONF_EXPORT_FILE}
_EOF

cat << _EOF > ${NFS_GANESHA_CONF_EXPORT_FILE}
MDCACHE {
    Entries_HWMark = ${NFS_GANESHA_EXPORT_HWMARK};
}
EXPORT {
    Export_Id = ${NFS_GANESHA_EXPORT_ID};
    Path = ${NFS_GANESHA_EXPORT_DIR};
    Pseudo = /;
    Protocols = 4;
    Transports = TCP;
    Access_Type = RW;
    Squash = ${NFS_GANESHA_EXPORT_SQUASH};
    Sectype = sys;
    FSAL {
        Name = VFS;
    }
}
LOG {
    COMPONENTS {
        ALL = ${NFS_GANESHA_EXPORT_LOG_LEVEL};
    }
}
_EOF

# In order to drop the root user, make some directories world
# writeable as OpenShift default security model is to run the container under
# random UID.

fix-permissions -u ${CTR_USER_ID} ${NFS_GANESHA_RUN_DIR} ${NFS_GANESHA_HOME} ${NFS_GANESHA_CONF_DIR} ${NFS_GANESHA_CONF_EXPORTS_DIR} ${NFS_GANESHA_EXPORTS_DIR} ${NFS_GANESHA_DBUS_RUN_DIR}

# restore rpm permissions
rpm-file-permissions

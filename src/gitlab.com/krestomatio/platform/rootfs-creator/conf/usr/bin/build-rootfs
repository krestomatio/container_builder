#!/bin/bash -e
# description: build rootfs
# param: 1. kickstart file and 2. rootfs file name to be generated


usage() {
    cat 1>&2 <<EOF
Script to create roofs with livemedia-creator

ENVIRONMENT VARS:
CTR_working_dir            working dir for kickstart source and image destination (default current directory)
BUILD_kickstart            kickstart source file ROOTFS_NAME
BUILD_rootfs               rootfs output file name

USAGE:
    build-rootfs KICKSTART_FILE ROOTFS_NAME

EXAMPLES:
    rootfs centos8-minimal.ks centos8-mininal.tar.xz
EOF
}

CTR_working_dir=${CTR_working_dir:-./}
BUILD_kickstart=${BUILD_kickstart:-$1}
BUILD_rootfs=${BUILD_rootfs:-$2}

if [ -z ${BUILD_kickstart} ] || [ -z ${BUILD_rootfs} ]
then
  echo "Please provide two parameters, kickstart source file and rootfs output file name"
  usage
  exit 1
fi

# create rootfs
livemedia-creator --logfile="/tmp/build-rootfs.log" \
    --make-tar --ks="${CTR_working_dir}/${BUILD_kickstart}" --no-virt \
    --image-only --image-name="${BUILD_rootfs}"

# move rootfs to working dir
mv /var/tmp/${BUILD_rootfs} ${CTR_working_dir}/${BUILD_rootfs}

# extract os-release info
tar -xvf ${CTR_working_dir}/${BUILD_rootfs} -C /tmp/ --strip-components=3 ./usr/lib/os-release
os_release_id=$(awk -F= '$1=="ID" { print $2 ;}' /tmp/os-release | tr -d '"')
distro_release=$(grep "${os_release_id}-release-" /tmp/anaconda/packaging.log | grep -o "Verifying:.*" | sed -n 's/Verifying: //p')

if [ -z ${distro_release+x} ]; then
    exit 1
else
    # save distro release info
    echo "$distro_release" > ${CTR_working_dir}/distro-release
fi

#!/bin/bash

set -e

# default ${CUSER} in ${CGROUP} group
usermod -a -G ${CGROUP} ${CUSER}

# In order to drop the root user, we have to make some directories world
# writeable as OpenShift default security model is to run the container under
# random UID.

mkdir -p ${PHP_RUN}
chmod -R a+rwx ${PHP_RUN}
chmod -R a+rwx ${HTTPD_MAIN_CONF_PATH}
chmod -R a+rwx ${HTTPD_MAIN_CONF_D_PATH}
chmod -R a+rwx ${HTTPD_VAR_RUN}
chmod -R a+rwx ${HTTPD_LOG_PATH}
mkdir -p /tmp/sessions
chmod -R a+rwx /tmp/sessions
chown -R ${CUSER_ID}:${CGROUP_ID} /tmp/sessions
chown -R ${CUSER_ID}:${CGROUP_ID} ${HTTPD_PUBLIC_PATH}
chmod -R a+rwx ${PHP_SYSCONF_PATH}

# httpd default config
sed -i \
    -e "s@^Listen 80.*@Listen 8080@" \
    -e "s@^User.*@User ${CUSER}@" \
    -e "s@^Group.*@Group ${CGROUP}@" \
    -e "s@^DocumentRoot.*@DocumentRoot \"${HTTPD_PUBLIC_PATH}\"@" \
    -e "s@^<Directory \"/var/www/html\"@<Directory \"${HTTPD_PUBLIC_PATH}\"@" \
    -re 's@^(\s*CustomLog)\s+\S+@\1 /proc/self/fd/1@g' \
    -re 's@^(\s*ErrorLog)\s+\S+@\1 /proc/self/fd/2@g' \
    -re 's@^(\s*TransferLog)\s+\S+@\1 /proc/self/fd/1@g' \
    ${HTTPD_MAIN_CONF_PATH}/httpd.conf

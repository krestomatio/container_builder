buildPack: none
noReleasePrepare: true
pipelineConfig:
  env:
  - name: CLOUD_PROVIDER
    value: m6e
  pipelines:
    pullRequest:
      pipeline:
        options:
          containerOptions:
            securityContext:
              privileged: true
          timeout:
            time: 60
            unit: minutes
        stages:
        - name: build
          agent:
            image: krestomatio/ansible-docker-ci
          steps:
          - name: fetch tags
            command: git fetch --tag
          - name: update submodules
            command: git submodule update --init --recursive
          - name: build containers
            command: sleep 1800 # ansible-playbook -i inventory/hosts build.yml
    release:
      pipeline:
        options:
          timeout:
            time: 60
            unit: minutes
        stages:
        - name: release
          agent:
            image: krestomatio/ansible-docker-ci
          steps:
          - name: fetch tags
            command: git fetch --tag
          - name: update submodules
            command: git submodule update --init --recursive
          - name: promote tag # create file to store promote tag from latest pull request number
            command: |
              PROMOTE_TAG_PR=$(git log --format=%B -n 1 -g --grep='Merge pull request #' | grep -oP '(?<= #)(\d+)')
              jx gitops pr get --pr $PROMOTE_TAG_PR 2>&1 | grep -oP '(?<=^Sha: ).*' > /tmp/PROMOTE_TAG
          - name: promote
            command: sleep 300 # ansible-playbook -i inventory/hosts release.yml

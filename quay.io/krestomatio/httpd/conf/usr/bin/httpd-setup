#!/bin/bash -e
# description: base config for httpd

# httpd default config
sed -i \
    -e 's@^Listen 80.*@Listen ${HTTPD_listen}@' \
    -e 's@^User.*@User ${HTTPD_user}@' \
    -e 's@^Group.*@Group ${HTTPD_group}@' \
    -e 's@^DocumentRoot.*@DocumentRoot "${HTTPD_documentroot}"@' \
    -e 's@^<Directory "/var/www/html"@<Directory "${HTTPD_documentroot}"@' \
    -re 's@^(\s*CustomLog)\s+\S+@\1 /proc/self/fd/1@g' \
    -re 's@^(\s*ErrorLog)\s+\S+@\1 /proc/self/fd/2@g' \
    -re 's@^(\s*TransferLog)\s+\S+@\1 /proc/self/fd/1@g' \
    ${HTTPD_main_conf_path}/httpd.conf

# httpd php-fpm config
cat << "_EOF" > ${HTTPD_main_conf_d_path}/60-php.conf
<IfModule !mod_php7.c>
    <IfModule proxy_fcgi_module>
        #
        # The following lines prevent .user.ini files from being viewed by Web clients.
        #
        <Files ".user.ini">
            Require all denied
        </Files>

        #
        # Allow php to handle Multiviews
        #
        AddType text/html .php

        #
        # Add index.php to the list of files that will be served as directory
        # indexes.
        #
        DirectoryIndex index.php

        #
        # Redirect to local php-fpm (no mod_php in default configuration)
        #
        # Enable http authorization headers
        SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1

        <FilesMatch \.(php|phar)$>
            SetHandler "proxy:fcgi://${PHP_FPM_host}:${PHP_FPM_port}"
        </FilesMatch>
    </IfModule>
</IfModule>
_EOF

httpd-permissions-set
